---
title: （二）全文搜索
description: ElasticSearch全文搜索
published: true
date: 2022-07-28T11:09:25.141Z
tags: elasticsearch
editor: markdown
dateCreated: 2022-07-27T12:26:35.955Z
---

# 全文搜索
> 全文搜索两个最重要的方面是：
{.is-info}
- **相关性（Relevance）**
它是评价查询与其结果间的相关程度，并根据这种相关程度对结果排名的一种能力，这种计算方式可以是 TF/IDF 方法（参见 相关性的介绍）、地理位置邻近、模糊相似，或其他的某些算法。
- **分析（Analysis）**
它是将文本块转换为有区别的、规范化的 token 的一个过程，（参见 分析的介绍） 目的是为了（a）创建倒排索引以及（b）查询倒排索引。
{.links-list}

## 基于词项与基于全文

### 基于词项的查询
如`term`或`fuzzy`这样的底层查询不需要分析阶段，它们对单个词项进行操作，只对倒排索引的词项精确匹配

### 基于全文的查询
像`match`或`query_string`这样的查询是高层查询，它们了解字段映射的信息：

- 如果查询`日期（date）`或`整数（integer）`字段，它们会将查询字符串分别作为日期或整数对待。
- 如果查询一个（`not_analyzed`）未分析的精确值字符串字段，它们会将整个查询字符串作为单个词项对待。
- 但如果要查询一个（`analyzed`）已分析的全文字段，它们会先将查询字符串传递到一个合适的分析器，然后生成一个供查询的词项列表。

## 匹配查询（`match`）
匹配查询`match`是个*核心*查询。无论需要查询什么字段，`match`查询都应该会是首选的查询方式。它是一个高级*全文查询*，这表示它既能处理全文字段，又能处理精确字段。
```
GET /my_index/my_type/_search
{
    "query": {
        "match": {
            "title": "QUICK!"
        }
    }
}
```
**查询的步骤是：**
1. 检查字段类型,是否需要分词（`term`）
2. 分析查询字符串，分为词项（`term`）
3. 查找匹配文档，用`term`查询在倒排索引中查找·quick·然后获取一组包含该项的文档
4. 为每个文档评分，用`term`查询计算每个文档相关度评分`_score`，这是种将词频（term frequency，即词 quick 在相关文档的`title`字段中出现的频率）和反向文档频率（inverse document frequency，即词`quick`在所有文档的`title`字段中出现的频率），以及字段的长度（即字段越短相关度越高）相结合的计算方式。

**查询结果：**
```
"hits": [
 {
    "_id":      "1",
    "_score":   0.5, 
    "_source": {
       "title": "The quick brown fox"
    }
 },
 {
    "_id":      "3",
    "_score":   0.44194174, 
    "_source": {
       "title": "The quick brown fox jumps over the quick dog"
    }
 },
 {
    "_id":      "2",
    "_score":   0.3125, 
    "_source": {
       "title": "The quick brown fox jumps over the lazy dog"
    }
 }
]
```
	
- 文档 `_id`为`1`最相关，因为它的`title`字段更短，即`quick`占据内容的一大部分。
- 文档`_id`为`3`比文档`_id`为`2`更具相关性，因为在文档`3`中`quick`出现了两次。
